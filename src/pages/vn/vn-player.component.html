
<div class="fixed inset-0 bg-black overflow-hidden flex items-center justify-center font-sans">
       
  @if (currentScene(); as scene) {
     <!-- === GAMEPLAY LAYER === -->
     
     <!-- BACKGROUND LAYER -->
     <div class="absolute inset-0 z-0 overflow-hidden">
        @if(scene.backgroundUrl) {
           <img [src]="scene.backgroundUrl" 
                class="w-full h-full object-cover transition-transform duration-[2000ms] ease-out"
                [class]="getTransitionClass(scene.transition)">
        } @else {
           <div class="w-full h-full bg-slate-900 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-800 to-slate-950"></div>
        }
        <!-- Cinematic Vignette -->
        <div class="absolute inset-0 bg-gradient-to-b from-black/60 via-transparent to-black/80 pointer-events-none"></div>
        
        <!-- Visual Effects Overlay (Particles) -->
        <div class="absolute inset-0 pointer-events-none z-10" [class]="getWeatherClass(scene.characterEffect)"></div>
     </div>

     <!-- CHARACTER LAYER -->
     @if (scene.characterUrl) {
        <div class="absolute bottom-0 left-1/2 -translate-x-1/2 h-[90%] z-10 pointer-events-none"
             [class]="getCharacterAnimationClass(scene.characterEffect)">
           <img [src]="scene.characterUrl" class="h-full object-contain drop-shadow-[0_10px_30px_rgba(0,0,0,0.8)] filter brightness-105">
        </div>
     }

     <!-- UI LAYER -->
     <div class="absolute inset-0 z-20 flex flex-col justify-end pb-8 px-4 md:px-0 pointer-events-none">
        
        <!-- CHOICES (Floating above dialogue) -->
        @if (scene.choices.length > 0 && !isTyping()) {
           <div class="absolute top-0 left-0 right-0 bottom-[280px] flex flex-col items-center justify-center gap-4 z-50 animate-fade-in px-4 pointer-events-auto">
              
              @for (choice of scene.choices; track $index) {
                 <button (click)="goToScene(choice.nextSceneId)" 
                         class="pointer-events-auto w-full max-w-lg py-4 bg-slate-900/90 hover:bg-slate-800/95 backdrop-blur-xl border border-white/10 hover:border-pink-500/50 text-white font-bold text-lg rounded-xl shadow-2xl transition-all transform hover:scale-105 animate-pop-in group relative overflow-hidden"
                         [style.animation-delay]="$index * 100 + 'ms'">
                    <div class="absolute inset-0 bg-gradient-to-r from-pink-600/0 via-pink-600/20 to-pink-600/0 translate-x-[-100%] group-hover:animate-shine"></div>
                    {{ choice.text }}
                 </button>
              }
           </div>
        }

        <!-- DIALOGUE BOX (Bottom) -->
        <div class="max-w-4xl mx-auto w-full pointer-events-auto relative z-40">
           <div (click)="handleDialogueClick()" 
                class="bg-[#0F0E17]/90 backdrop-blur-xl border border-white/10 rounded-[2rem] p-8 md:p-10 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] cursor-pointer hover:bg-[#0F0E17]/95 transition-colors relative overflow-hidden group">
              
              <!-- Decoration Lines -->
              <div class="absolute top-0 left-10 right-10 h-[1px] bg-gradient-to-r from-transparent via-white/20 to-transparent"></div>

              <!-- Speaker Name Tag (Floating) -->
              @if (scene.speakerName) {
                <div class="absolute -top-5 left-8 bg-pink-600 text-white px-6 py-2 rounded-xl font-bold text-lg shadow-lg border-2 border-[#0F0E17] tracking-wide transform -rotate-1 group-hover:rotate-0 transition-transform">
                   {{ scene.speakerName }}
                </div>
              }

              <!-- Text Content -->
              <div class="mt-2 min-h-[80px]">
                 <p class="text-slate-100 text-lg md:text-xl leading-relaxed font-medium font-serif tracking-wide text-shadow">
                    {{ displayedText() }}<span class="animate-pulse text-pink-500 font-bold" *ngIf="isTyping()">|</span>
                 </p>
              </div>
              
              <!-- Next Indicator (Shows ONLY if no choices, or waiting for click) -->
              @if (!isTyping() && scene.choices.length === 0) {
                 <div class="absolute bottom-6 right-8 text-pink-500 animate-bounce flex items-center gap-2">
                    <span class="text-xs font-bold uppercase tracking-widest opacity-70">
                       {{ scene.nextSceneId ? 'Toque para Continuar' : 'Fim' }}
                    </span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
                       <path *ngIf="scene.nextSceneId" fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" />
                       <path *ngIf="!scene.nextSceneId" fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-11a1 1 0 00-2 0v6a1 1 0 102 0V7zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                    </svg>
                 </div>
              }
           </div>
        </div>

        <!-- Exit Button -->
        <button (click)="exit()" class="absolute top-6 right-6 pointer-events-auto bg-black/40 hover:bg-red-600 text-white w-10 h-10 flex items-center justify-center rounded-full backdrop-blur border border-white/10 transition-all z-50">
           âœ•
        </button>
     </div>

  } @else if (creditsData(); as credits) {
     
     <!-- === END SCREEN / CREDITS LAYER === -->
     <div class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-black overflow-hidden">
        
        <!-- Background -->
        @if (credits.backgroundImageUrl) {
            <div class="absolute inset-0 z-0">
               <img [src]="credits.backgroundImageUrl" class="w-full h-full object-cover blur-sm opacity-40 scale-105 animate-zoom-in">
               <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-black"></div>
            </div>
        }

        <!-- Credits Container -->
        <div class="relative z-10 w-full h-full flex flex-col items-center justify-center p-8 text-center animate-fade-in">
           
           <h1 class="text-6xl md:text-8xl font-black text-white mb-8 tracking-tighter drop-shadow-2xl uppercase">
              {{ credits.endingTitle }}
           </h1>

           <!-- Scrolling Text -->
           <div class="h-64 overflow-hidden relative w-full max-w-xl mb-8 mask-gradient">
              <div class="animate-scroll-up absolute top-full left-0 right-0 text-slate-300 text-lg leading-relaxed whitespace-pre-wrap font-medium">
                 {{ credits.scrollingText }}
              </div>
           </div>

           <!-- Rewards -->
           <div class="flex items-center gap-4 mb-12 bg-white/5 backdrop-blur-md px-6 py-3 rounded-full border border-white/10 animate-slide-up">
              @if (rewardCoins > 0) {
                  <div class="text-yellow-400 font-bold flex items-center gap-2">
                     <span>ðŸª™</span> +{{ rewardCoins }} Coins
                  </div>
                  <div class="w-px h-4 bg-white/20"></div>
              }
              <div class="text-blue-400 font-bold flex items-center gap-2">
                 <span>âœ¨</span> +100 XP
              </div>
           </div>

           <!-- Action Buttons -->
           <div class="flex flex-col sm:flex-row gap-4 w-full max-w-md animate-slide-up" style="animation-delay: 0.2s">
              <button (click)="restart()" class="flex-1 py-4 bg-white text-black font-black uppercase tracking-widest rounded-xl hover:scale-105 transition-transform shadow-xl">
                 Jogar Novamente
              </button>
              <button (click)="exit()" class="flex-1 py-4 bg-transparent border-2 border-white/20 text-white font-bold uppercase tracking-widest rounded-xl hover:bg-white/10 transition-colors">
                 Voltar ao Menu
              </button>
           </div>
        </div>
     </div>
  }
</div>

<style>
  .mask-gradient {
     mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent);
     -webkit-mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent);
  }
</style>
