
<app-header></app-header>

<div class="min-h-screen pt-4 pb-20 max-w-6xl mx-auto px-4 page-enter">
  
  @if (novel(); as wn) {
    <div class="flex flex-col md:flex-row gap-6">
       
       <!-- META -->
       <div class="w-full md:w-80 flex flex-col gap-4 bg-slate-900/50 p-6 rounded-3xl border border-white/5 h-fit md:sticky md:top-24">
          
          <!-- Cover -->
          <div class="space-y-2">
            <label class="text-[10px] text-slate-500 font-bold uppercase">Capa do Livro</label>
            <div class="aspect-[2/3] rounded-xl overflow-hidden border border-white/10 relative group">
               <img [src]="wn.coverUrl" class="w-full h-full object-cover transition-opacity" [class.opacity-50]="isGeneratingCover()">
               
               @if (isGeneratingCover()) {
                 <div class="absolute inset-0 flex items-center justify-center">
                    <span class="animate-spin text-3xl">üîÆ</span>
                 </div>
               }

               <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 flex flex-col items-center justify-center gap-2 transition-opacity">
                  <button (click)="uploadCover()" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-full text-xs font-bold text-white border border-white/20">
                     üìÅ Upload
                  </button>
                  <button (click)="generateAiCover()" class="px-4 py-2 bg-gradient-to-r from-pink-600 to-purple-600 rounded-full text-xs font-bold text-white shadow-lg">
                     ‚ú® Gerar IA (50)
                  </button>
               </div>
            </div>
            <input type="file" id="coverUpload" class="hidden" accept="image/*" (change)="onCoverSelected($event)">
          </div>

          <div class="space-y-1">
             <label class="text-[10px] text-slate-500 font-bold uppercase">T√≠tulo</label>
             <input [(ngModel)]="wn.title" class="w-full bg-slate-950 border border-slate-700 rounded-xl p-3 text-white text-sm focus:border-emerald-500 outline-none placeholder-slate-600" placeholder="O t√≠tulo da sua obra...">
          </div>

          <div class="space-y-1">
             <label class="text-[10px] text-slate-500 font-bold uppercase">Sinopse</label>
             <textarea [(ngModel)]="wn.description" rows="6" class="w-full bg-slate-950 border border-slate-700 rounded-xl p-3 text-white text-sm resize-none focus:border-emerald-500 outline-none placeholder-slate-600" placeholder="Sobre o que √© a hist√≥ria?"></textarea>
          </div>

          <!-- NSFW TOGGLE -->
          <div class="flex items-center justify-between p-3 bg-slate-950 rounded-xl border border-slate-700">
             <div>
                <span class="text-xs font-bold text-white block">Conte√∫do +18</span>
                <span class="text-[9px] text-slate-500 block">Se desmarcado, a IA ir√° filtrar o conte√∫do.</span>
             </div>
             <label class="relative inline-flex items-center cursor-pointer">
               <input type="checkbox" [(ngModel)]="isNSFW" class="sr-only peer">
               <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
             </label>
          </div>

          <button (click)="saveNovel()" 
                  [disabled]="isSaving()"
                  class="w-full py-4 bg-emerald-600 hover:bg-emerald-500 rounded-xl text-white font-bold transition-all shadow-lg hover:shadow-emerald-500/20 active:scale-95 disabled:opacity-70 disabled:scale-100">
             @if(isSaving()) { <span class="animate-spin inline-block mr-2">‚Üª</span> Salvando... }
             @else { Salvar Altera√ß√µes }
          </button>
       </div>

       <!-- CHAPTERS -->
       <div class="flex-1 flex flex-col gap-6 pb-20">
          <div class="flex justify-between items-center border-b border-white/10 pb-4">
             <div>
                <h2 class="text-white font-bold text-2xl">Cap√≠tulos</h2>
                <p class="text-slate-400 text-xs mt-1">Gerencie o conte√∫do do seu livro.</p>
             </div>
             <button (click)="addChapter()" class="px-5 py-2.5 bg-slate-800 hover:bg-slate-700 rounded-xl text-emerald-400 text-sm font-bold border border-slate-700 transition-colors flex items-center gap-2">
                <span>+</span> Novo Cap√≠tulo
             </button>
          </div>

          <div class="space-y-8">
             @for (chap of wn.chapters; track chap.id; let idx = $index) {
                <div class="bg-slate-900 border border-slate-700 rounded-3xl p-6 relative group hover:border-slate-600 transition-colors shadow-sm">
                   
                   <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                      <div class="flex-1 w-full">
                         <label class="text-[10px] text-slate-500 uppercase font-bold mb-1 block">T√≠tulo do Cap√≠tulo {{idx + 1}}</label>
                         <input [(ngModel)]="chap.title" class="w-full bg-transparent text-white font-bold text-xl border-b border-slate-700 focus:border-emerald-500 outline-none pb-2 placeholder-slate-600">
                      </div>
                      <button (click)="deleteChapter(idx)" class="text-slate-500 hover:text-red-500 transition-colors p-2 hover:bg-red-500/10 rounded-lg self-end sm:self-auto">
                         Excluir
                      </button>
                   </div>
                   
                   <!-- TEXT EDITOR -->
                   <div class="relative">
                      <textarea [id]="'area-'+idx" [(ngModel)]="chap.content" rows="15" class="w-full bg-black/30 border border-slate-800 rounded-2xl p-5 text-slate-300 text-base leading-relaxed resize-y focus:outline-none focus:border-emerald-500/50 font-serif min-h-[300px]" placeholder="Escreva sua hist√≥ria aqui..."></textarea>
                      
                      <div class="absolute bottom-4 right-4 flex gap-2">
                         <label class="cursor-pointer bg-slate-800 hover:bg-slate-700 text-white p-2.5 rounded-xl shadow-lg border border-slate-700 transition-all hover:scale-110" title="Inserir Imagem">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                            <input type="file" class="hidden" accept="image/*" (change)="insertImage($event, idx)">
                         </label>
                      </div>
                   </div>
                   
                   <p class="text-[10px] text-slate-600 mt-3 ml-1 italic">
                      Dica: Use markdown para formata√ß√£o (*it√°lico*, **negrito**).
                   </p>
                </div>
             }

             @if (wn.chapters.length === 0) {
                <div class="text-center py-16 border-2 border-dashed border-slate-800 rounded-3xl">
                   <p class="text-slate-500 mb-4">Nenhum cap√≠tulo criado.</p>
                   <button (click)="addChapter()" class="text-emerald-500 font-bold hover:underline">Come√ßar a escrever</button>
                </div>
             }
          </div>
       </div>

    </div>
  }
</div>
