
<app-header></app-header>
    
<div class="min-h-screen pb-32 max-w-2xl mx-auto page-enter pt-4 transition-colors duration-500 bg-[#0F0E17]">
  
  @if (auth.currentUser(); as user) {
    
    <!-- 1. TOPO: NAVEGA√á√ÉO -->
    <div class="flex items-center justify-between px-4 py-2 text-white sticky top-0 bg-[#0F0E17]/95 backdrop-blur z-30">
       <div class="flex items-center gap-2">
          <span class="font-bold text-lg">{{ user.username }}</span>
          @if(user.isAdultVerified) {
             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-pink-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
          }
       </div>
       <div class="flex gap-4">
          <button (click)="createNew()" class="text-white hover:text-pink-500 transition-colors">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
          </button>
          <button (click)="auth.logout()" class="text-white hover:text-red-500 transition-colors">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
          </button>
       </div>
    </div>

    <!-- 2. INFO PRINCIPAL -->
    <div class="px-4 mt-4">
       <div class="flex items-center justify-between">
          
          <!-- Avatar (Esquerda) -->
          <div class="relative group cursor-pointer" (click)="editMode() ? triggerUpload('avatar') : startEdit()">
             <div class="w-20 h-20 rounded-full p-[2px] bg-gradient-to-tr from-pink-500 to-yellow-500">
                <div class="w-full h-full rounded-full border-2 border-[#0F0E17] overflow-hidden bg-slate-800">
                   <img [src]="editMode() ? editData.avatarUrl : user.avatarUrl" class="w-full h-full object-cover">
                </div>
             </div>
             @if (editMode()) {
                <div class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-full">
                   <span class="text-[10px] text-white font-bold">Mudar</span>
                </div>
             }
          </div>

          <!-- Stats (Direita) -->
          <div class="flex-1 flex justify-around text-center ml-4">
             <div class="flex flex-col">
                <span class="font-bold text-lg text-white">{{ myCharacters().length }}</span>
                <span class="text-xs text-slate-400">Posts</span>
             </div>
             <div class="flex flex-col">
                <span class="font-bold text-lg text-white">{{ followersCount() }}</span>
                <span class="text-xs text-slate-400">Seguidores</span>
             </div>
             <div class="flex flex-col">
                <span class="font-bold text-lg text-white">{{ followingCount() }}</span>
                <span class="text-xs text-slate-400">Seguindo</span>
             </div>
          </div>
       </div>

       <!-- Bio e Nome -->
       <div class="mt-3">
          @if (!editMode()) {
             <div class="font-bold text-white text-sm">{{ user.username }}</div>
             <div class="text-sm text-slate-300 whitespace-pre-wrap leading-relaxed">{{ user.bio || 'Sem biografia.' }}</div>
             
             <!-- Level Badge -->
             <div class="mt-2 inline-flex items-center gap-1 px-2 py-0.5 rounded bg-slate-800 border border-slate-700">
                <span class="text-[10px] text-pink-400 font-bold uppercase">N√≠vel {{ economy.userLevel() }}</span>
             </div>
          } @else {
             <div class="space-y-2 mt-2 bg-slate-900/50 p-3 rounded-xl border border-white/10">
                <input [(ngModel)]="editData.username" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white focus:border-pink-500 outline-none" placeholder="Nome">
                <textarea [(ngModel)]="editData.bio" rows="3" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white resize-none focus:border-pink-500 outline-none" placeholder="Bio"></textarea>
             </div>
          }
       </div>

       <!-- Bot√µes de A√ß√£o -->
       <div class="flex gap-2 mt-4">
          @if (!editMode()) {
             <button (click)="startEdit()" class="flex-1 py-1.5 bg-slate-800 rounded-lg text-sm font-bold text-white hover:bg-slate-700 transition-colors border border-slate-700">
                Editar Perfil
             </button>
             <button class="flex-1 py-1.5 bg-slate-800 rounded-lg text-sm font-bold text-white hover:bg-slate-700 transition-colors border border-slate-700">
                Compartilhar
             </button>
             <button (click)="toggleNSFW()" class="w-10 flex items-center justify-center bg-slate-800 rounded-lg border border-slate-700 text-slate-400 hover:text-white" [title]="user.showNSFW ? 'Ocultar NSFW' : 'Mostrar NSFW'">
                {{ user.showNSFW ? 'üîû' : 'üõ°Ô∏è' }}
             </button>
          } @else {
             <button (click)="saveEdit()" class="flex-1 py-1.5 bg-pink-600 rounded-lg text-sm font-bold text-white hover:bg-pink-500 transition-colors">
                Salvar
             </button>
             <button (click)="cancelEdit()" class="flex-1 py-1.5 bg-slate-800 rounded-lg text-sm font-bold text-white hover:bg-slate-700 border border-slate-700">
                Cancelar
             </button>
          }
       </div>
    </div>

    <!-- 3. ABAS DE CONTE√öDO -->
    <div class="flex border-b border-slate-800 mt-6 sticky top-[52px] bg-[#0F0E17] z-20">
       <button (click)="activeTab.set('creations')" class="flex-1 pb-3 relative" [class.text-white]="activeTab() === 'creations'" [class.text-slate-500]="activeTab() !== 'creations'">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
          <div *ngIf="activeTab() === 'creations'" class="absolute bottom-0 left-0 right-0 h-0.5 bg-white mx-4 rounded-full"></div>
       </button>
       <button (click)="activeTab.set('favorites')" class="flex-1 pb-3 relative" [class.text-white]="activeTab() === 'favorites'" [class.text-slate-500]="activeTab() !== 'favorites'">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
          <div *ngIf="activeTab() === 'favorites'" class="absolute bottom-0 left-0 right-0 h-0.5 bg-white mx-4 rounded-full"></div>
       </button>
    </div>

    <!-- 4. GRADE DE CONTE√öDO -->
    <div class="min-h-[300px]">
       
       <!-- Grid de Personagens -->
       @if (activeTab() === 'creations') {
          <div class="grid grid-cols-3 gap-0.5">
             <!-- Card Criar Novo (Primeiro slot) -->
             <div (click)="createNew()" class="aspect-[3/4] bg-slate-900 flex flex-col items-center justify-center cursor-pointer border-r border-b border-black/50 hover:bg-slate-800 transition-colors">
                <div class="w-8 h-8 rounded-full border-2 border-white/20 flex items-center justify-center text-white/50 mb-1">+</div>
                <span class="text-[10px] text-white/50 font-bold uppercase">Novo</span>
             </div>

             <!-- Personagens com Rank -->
             @for (char of myCharacters(); track char.id; let idx = $index) {
                <div class="relative group aspect-[3/4] cursor-pointer overflow-hidden border-r border-b border-black/50">
                   <app-character-card [character]="char" [rank]="idx + 1"></app-character-card>
                </div>
             }
          </div>

          @if (myCharacters().length === 0) {
             <div class="py-20 text-center">
                <div class="text-4xl mb-2">üì∏</div>
                <h3 class="text-white font-bold">Sem publica√ß√µes</h3>
                <p class="text-slate-500 text-sm">Crie seu primeiro personagem!</p>
             </div>
          }
       } 
       
       <!-- Grid Favoritos (Placeholder) -->
       @else {
          <div class="py-20 text-center">
             <div class="text-4xl mb-2 text-slate-700">üîí</div>
             <p class="text-slate-500 text-sm">Favoritos privados.</p>
          </div>
       }

    </div>

  }
  
  <!-- Inputs Ocultos -->
  <input type="file" id="avatarInput" class="hidden" accept="image/png, image/jpeg, image/webp" (change)="onFileSelected($event, 'avatar')">
  
  <!-- CROP MODAL -->
  @if (showCropper()) {
     <app-image-cropper-modal
        [imageBase64]="tempImage()"
        [aspectRatio]="cropAspectRatio()"
        [round]="cropRound()"
        (saveImage)="onCropComplete($event)"
        (cancel)="cancelCrop()">
     </app-image-cropper-modal>
  }
</div>
